<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <title>PlotFish ‚Äì Resolver um problema da hist√≥ria</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#121826" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 16px;
      max-width: 900px;
      margin-inline: auto;
      background: #0b1220;
      color: #e5e7eb;
    }
    h1, h2, h3 {
      margin: 0 0 8px;
    }
    h1 {
      font-size: 1.6rem;
    }
    h2 {
      font-size: 1.2rem;
      margin-top: 16px;
    }
    p {
      margin: 4px 0 8px;
      font-size: 0.95rem;
      color: #cbd5f5;
    }
    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(59,130,246,0.2);
      color: #bfdbfe;
      font-size: 0.8rem;
      margin-bottom: 4px;
    }
    .card {
      background: radial-gradient(circle at top left, #1f2937, #020617);
      border-radius: 10px;
      padding: 12px 14px;
      margin-bottom: 12px;
      border: 1px solid rgba(148,163,184,0.2);
    }
    label {
      display: block;
      font-size: 0.85rem;
      margin-top: 6px;
      color: #e5e7eb;
    }
    textarea, input, select {
      width: 100%;
      box-sizing: border-box;
      margin-top: 2px;
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #4b5563;
      background: #020617;
      color: #e5e7eb;
      font-size: 0.9rem;
    }
    textarea {
      min-height: 60px;
      resize: vertical;
    }
    button {
      border: none;
      border-radius: 999px;
      padding: 7px 12px;
      font-size: 0.9rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      margin-top: 8px;
    }
    .primary {
      background: linear-gradient(to right, #3b82f6, #6366f1);
      color: white;
    }
    .secondary {
      background: #111827;
      color: #e5e7eb;
      border: 1px solid #4b5563;
    }
    .danger {
      background: #b91c1c;
      color: white;
    }
    .area-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 4px;
    }
    .area-title-main {
      font-weight: 600;
      font-size: 0.95rem;
    }
    .area-subtitle {
      font-size: 0.8rem;
      color: #9ca3af;
    }
    .hypothesis-card {
      border-radius: 8px;
      border: 1px solid rgba(148,163,184,0.3);
      padding: 8px;
      margin-top: 8px;
      background: rgba(15,23,42,0.8);
    }
    .hypothesis-row {
      display: grid;
      grid-template-columns: 1fr;
      gap: 6px;
    }
    @media (min-width: 640px) {
      .hypothesis-row {
        grid-template-columns: 1.2fr 0.9fr 0.9fr 0.9fr;
      }
    }
    .hypothesis-label {
      font-size: 0.75rem;
      color: #9ca3af;
      margin-top: 4px;
      margin-bottom: 2px;
    }
    #summaryBox {
      min-height: 160px;
      white-space: pre-wrap;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.85rem;
    }
    .small-hint {
      font-size: 0.78rem;
      color: #9ca3af;
    }
    header {
      margin-bottom: 14px;
      padding-bottom: 8px;
      border-bottom: 1px solid rgba(148,163,184,0.3);
    }
    .logo-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }
    .logo-mark {
      font-size: 1.1rem;
      font-weight: 600;
      letter-spacing: 0.04em;
    }
  </style>
</head>
<body>
  <header>
    <div class="logo-row">
      <div>
        <div class="badge">MVP ¬∑ modo 1</div>
        <h1>PlotFish</h1>
        <p style="margin-bottom:4px;">
          Ferramenta de brainstorming para autores de fantasia & sci-fi que querem
          <strong>desbloquear problemas da hist√≥ria</strong> em vez de s√≥ sentir ‚Äúisto n√£o est√° a funcionar‚Äù.
        </p>
      </div>
      <div class="logo-mark">üêü</div>
    </div>
    <p class="small-hint">
      Come√ßa por descrever o problema, depois explora hip√≥teses por √°rea (personagens, enredo, mundo, etc.).
      No final, gera um resumo ou um diagrama fishbone para reveres ou reescreveres a cena.
    </p>
  </header>

  <!-- PASSO 1 -->
  <section class="card">
    <h2>Passo 1 ¬∑ Qual √© o problema da hist√≥ria?</h2>
    <label>
      Descreve, em linguagem simples, o que n√£o est√° a funcionar.
      <textarea id="problemDescription" placeholder="Ex.: O cl√≠max da hist√≥ria √© morno; quando a personagem X morre, n√£o sinto impacto; o meio do livro arrasta."></textarea>
    </label>

    <label>
      Tipo de problema (opcional)
      <select id="problemType">
        <option value="">N√£o tenho a certeza / prefiro n√£o escolher</option>
        <option value="Cena espec√≠fica">Cena espec√≠fica</option>
        <option value="Arco de personagem">Arco de personagem</option>
        <option value="Cl√≠max / final">Cl√≠max / final</option>
        <option value="Ritmo / enchimento">Ritmo / enchimento</option>
        <option value="Mundo / magia / tecnologia">Mundo / magia / tecnologia</option>
      </select>
    </label>
  </section>

  <!-- PASSO 2 -->
  <section>
    <h2>Passo 2 ¬∑ Explora onde o problema pode estar</h2>
    <p class="small-hint">
      Usa as √°reas abaixo como ‚Äúespinhas‚Äù do teu fishbone. Para cada uma que fizer sentido,
      escreve hip√≥teses e, se quiseres, aprofunda com at√© 3 ‚Äúporqu√™s‚Äù.
    </p>

    <div id="areasContainer"></div>
  </section>

  <!-- PASSO 3 -->
  <section class="card" style="margin-top:16px;">
    <h2>Passo 3 ¬∑ Resumo para revis√£o</h2>
    <p class="small-hint">
      Gera um texto com o problema, as √°reas onde suspeitas que est√° a falha e as hip√≥teses que
      queres explorar. Depois, se quiseres, podes tamb√©m gerar uma imagem tipo fishbone.
    </p>
    <div style="display:flex;flex-wrap:wrap;gap:8px;">
      <button class="primary" type="button" onclick="generateSummary()">
        üßæ Gerar resumo
      </button>
      <button class="secondary" type="button" onclick="copySummary()">
        üìã Copiar resumo
      </button>
      <button class="secondary" type="button" onclick="generateFishboneImage()">
        üé® Gerar imagem fishbone
      </button>
      <button class="secondary" type="button" onclick="clearAll()">
        üîÑ Limpar tudo
      </button>
    </div>

    <label style="margin-top:10px;">
      Resultado
      <textarea id="summaryBox" readonly></textarea>
    </label>
  </section>

  <!-- IMAGEM FISHBONE -->
  <section id="fishboneSection" style="margin-top:16px; display:none;">
    <h2>Diagrama fishbone</h2>
    <p class="small-hint">
      Diagrama gerado a partir do problema e das hip√≥teses que escreveste. Mant√©m o dedo em cima
      da imagem (no telem√≥vel/tablet) para guardar ou partilhar.
    </p>
    <div class="card">
      <img id="fishboneImage" alt="Diagrama fishbone gerado" style="width:100%;max-width:100%;border-radius:8px;display:block;" />
    </div>
  </section>

  <script>
    "use strict";

    // Defini√ß√£o das √°reas (espinhas)
    const AREAS = [
      {
        id: "personagens",
        title: "Personagens",
        subtitle: "Motiva√ß√µes, decis√µes, rea√ß√µes, arcos.",
        hints: [
          "As motiva√ß√µes est√£o claras?",
          "As decis√µes fazem sentido com quem a personagem √©?",
          "H√° algo que devia doer mais (ou menos)?"
        ]
      },
      {
        id: "enredo",
        title: "Enredo (plot)",
        subtitle: "Acontecimentos, viragens, consequ√™ncia dos atos.",
        hints: [
          "As causas e efeitos est√£o claros?",
          "H√° atalhos convenientes a mais?",
          "O cl√≠max foi preparado ao longo da hist√≥ria?"
        ]
      },
      {
        id: "conflito",
        title: "Conflito & stakes",
        subtitle: "O que est√° em jogo, o que se perde se falhar.",
        hints: [
          "O leitor sente o que est√° em risco?",
          "O protagonista tem mesmo algo a perder?",
          "Se falhar, acontece algo significativo?"
        ]
      },
      {
        id: "mundo",
        title: "Mundo / magia / tecnologia",
        subtitle: "Regras, custo, limites, coer√™ncia interna.",
        hints: [
          "As regras s√£o claras o suficiente?",
          "H√° magia/tech a resolver tudo sem custo?",
          "O mundo reage √†s a√ß√µes das personagens?"
        ]
      },
      {
        id: "tema",
        title: "Tema & emo√ß√£o",
        subtitle: "Mensagem, tom, impacto emocional.",
        hints: [
          "Que emo√ß√£o querias que o leitor sentisse aqui?",
          "A cena est√° alinhada com o tema da hist√≥ria?",
          "H√° conflito interno suficiente?"
        ]
      },
      {
        id: "ritmo",
        title: "Ritmo & estrutura",
        subtitle: "Partes que arrastam, saltos bruscos, enchimento.",
        hints: [
          "H√° cenas que repetem a mesma fun√ß√£o?",
          "Chegaste cedo demais ou tarde demais ao ponto chave?",
          "H√° blocos de info que podiam ser divididos?"
        ]
      }
    ];

    // Inicializa√ß√£o da UI das √°reas
    function initAreas() {
      const container = document.getElementById("areasContainer");
      container.innerHTML = "";

      AREAS.forEach(area => {
        const card = document.createElement("div");
        card.className = "card";
        card.dataset.areaId = area.id;

        card.innerHTML = `
          <div class="area-header">
            <div>
              <div class="area-title-main">${area.title}</div>
              <div class="area-subtitle">${area.subtitle}</div>
            </div>
            <button type="button" class="secondary" onclick="addHypothesis('${area.id}')">
              + Adicionar hip√≥tese
            </button>
          </div>
          <p class="small-hint">
            Sugest√µes para pensar: ${area.hints.join(" ¬∑ ")}
          </p>
          <div class="small-hint">
            Usa esta √°rea se achas que o problema pode estar aqui. Podes adicionar v√°rias hip√≥teses
            e aprofundar com at√© 3 ‚Äúporqu√™s‚Äù cada.
          </div>
          <div class="hypotheses-container" id="hypotheses-${area.id}"></div>
        `;

        container.appendChild(card);
      });
    }

    // Adiciona um bloco de hip√≥tese + porqu√™s a uma √°rea
    function addHypothesis(areaId) {
      const container = document.getElementById(`hypotheses-${areaId}`);
      if (!container) return;

      const hypIndex = container.children.length + 1;

      const wrapper = document.createElement("div");
      wrapper.className = "hypothesis-card";

      wrapper.innerHTML = `
        <div class="hypothesis-row">
          <div>
            <div class="hypothesis-label">Hip√≥tese #${hypIndex}</div>
            <textarea
              placeholder="Ex.: O protagonista aceita o risco demasiado depressa."
              class="hypothesis-text"
            ></textarea>
          </div>
          <div>
            <div class="hypothesis-label">Porqu√™ 1 (o que pode estar por tr√°s?)</div>
            <textarea class="why1" placeholder="Ex.: Porque n√£o mostrei o que ele tem a perder."></textarea>
          </div>
          <div>
            <div class="hypothesis-label">Porqu√™ 2 (e isso porqu√™?)</div>
            <textarea class="why2" placeholder="Ex.: Porque nunca foquei a vida 'normal' dele."></textarea>
          </div>
          <div>
            <div class="hypothesis-label">Porqu√™ 3 (h√° algo ainda mais fundo?)</div>
            <textarea class="why3" placeholder="Ex.: Porque n√£o defini claramente o medo central dele."></textarea>
          </div>
        </div>
        <button type="button" class="danger" style="margin-top:6px;" onclick="removeHypothesis(this)">
          Remover hip√≥tese
        </button>
      `;

      container.appendChild(wrapper);
    }

    function removeHypothesis(buttonEl) {
      const card = buttonEl.closest(".hypothesis-card");
      if (card && card.parentElement) {
        card.parentElement.removeChild(card);
      }
    }

    // Gera o resumo de tudo
    function generateSummary() {
      const problem = document.getElementById("problemDescription").value.trim();
      const type = document.getElementById("problemType").value;

      if (!problem) {
        alert("Come√ßa por descrever o problema da hist√≥ria no Passo 1.");
        return;
      }

      let lines = [];

      lines.push("PLOT FISH ‚Äì RESUMO DO BRAINSTORM");
      lines.push("=".repeat(40));
      lines.push("");

      lines.push("Problema descrito:");
      lines.push(problem);
      lines.push("");

      if (type) {
        lines.push(`Tipo de problema: ${type}`);
        lines.push("");
      }

      lines.push("√Åreas exploradas e hip√≥teses:");
      lines.push("");

      AREAS.forEach(area => {
        const container = document.getElementById(`hypotheses-${area.id}`);
        if (!container) return;
        const cards = Array.from(container.getElementsByClassName("hypothesis-card"));
        if (cards.length === 0) return;

        lines.push(`- ${area.title}:`);
        cards.forEach((card, idx) => {
          const hyp = card.querySelector(".hypothesis-text")?.value.trim();
          const why1 = card.querySelector(".why1")?.value.trim();
          const why2 = card.querySelector(".why2")?.value.trim();
          const why3 = card.querySelector(".why3")?.value.trim();

          if (!hyp && !why1 && !why2 && !why3) return;

          lines.push(`  ‚Ä¢ Hip√≥tese ${idx + 1}: ${hyp || "(n√£o preenchido)"}`);

          if (why1) lines.push(`      ‚Äì Porqu√™ 1: ${why1}`);
          if (why2) lines.push(`      ‚Äì Porqu√™ 2: ${why2}`);
          if (why3) lines.push(`      ‚Äì Porqu√™ 3: ${why3}`);
        });
        lines.push("");
      });

      lines.push("Notas para revis√£o:");
      lines.push(
        "‚Ä¢ Olhar para as hip√≥teses com mais 'porqu√™s' preenchidos ‚Äì podem indicar causas mais profundas."
      );
      lines.push(
        "‚Ä¢ Escolher 1‚Äì3 mudan√ßas concretas para testar (reescrever uma cena, clarificar motiva√ß√µes, alterar stakes, etc.)."
      );

      const summaryText = lines.join("\n");
      document.getElementById("summaryBox").value = summaryText;
    }

    // Copia o resumo para clipboard
    function copySummary() {
      const summaryEl = document.getElementById("summaryBox");
      const text = summaryEl.value;
      if (!text.trim()) {
        alert("Ainda n√£o h√° resumo para copiar. Gera primeiro o resumo.");
        return;
      }

      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text)
          .then(() => {
            alert("Resumo copiado. Cola no teu editor de texto ou notas.");
          })
          .catch(err => {
            console.error("Erro a copiar para clipboard", err);
            fallbackCopy(text);
          });
      } else {
        fallbackCopy(text);
      }
    }

    function fallbackCopy(text) {
      const ok = window.prompt(
        "Copia manualmente o texto (Ctrl+C / Command+C) e depois Enter:",
        text
      );
      if (!ok) {
        // nada
      }
    }

    // Helper para texto multi-linha no canvas
    function drawWrappedText(ctx, text, x, y, maxWidth, lineHeight) {
      const words = text.split(" ");
      let line = "";
      for (let n = 0; n < words.length; n++) {
        const testLine = line + words[n] + " ";
        const metrics = ctx.measureText(testLine);
        const testWidth = metrics.width;
        if (testWidth > maxWidth && n > 0) {
          ctx.fillText(line, x, y);
          line = words[n] + " ";
          y += lineHeight;
        } else {
          line = testLine;
        }
      }
      if (line) {
        ctx.fillText(line, x, y);
      }
      return y;
    }

    // Gera uma imagem tipo fishbone com o problema e as √°reas
    function generateFishboneImage() {
      const problem = document.getElementById("problemDescription").value.trim();
      if (!problem) {
        alert("Para gerar o fishbone, primeiro descreve o problema no Passo 1.");
        return;
      }

      // Recolher hip√≥teses por √°rea (apenas as primeiras 1‚Äì2 para n√£o ficar ileg√≠vel)
      const branchData = [];
      AREAS.forEach(area => {
        const container = document.getElementById(`hypotheses-${area.id}`);
        if (!container) return;
        const cards = Array.from(container.getElementsByClassName("hypothesis-card"));
        if (cards.length === 0) return;

        const texts = [];
        for (const card of cards) {
          const hyp = card.querySelector(".hypothesis-text")?.value.trim();
          if (hyp) texts.push("‚Ä¢ " + hyp);
          if (texts.length >= 2) break; // limitar a 2 por √°rea
        }
        if (texts.length === 0) return;

        branchData.push({
          title: area.title,
          lines: texts
        });
      });

      if (branchData.length === 0) {
        alert("Ainda n√£o h√° hip√≥teses preenchidas nas √°reas. Adiciona pelo menos uma hip√≥tese numa √°rea para gerar o fishbone.");
        return;
      }

      // Canvas horizontal
      const canvas = document.createElement("canvas");
      canvas.width = 1600;
      canvas.height = 900;
      const ctx = canvas.getContext("2d");

      // Fundo
      const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
      gradient.addColorStop(0, "#020617");
      gradient.addColorStop(1, "#111827");
      ctx.fillStyle = gradient;
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      // Espinha central
      const centerY = canvas.height / 2;
      const spineStartX = 150;
      const spineEndX = canvas.width - 250;
      ctx.strokeStyle = "#e5e7eb";
      ctx.lineWidth = 4;
      ctx.beginPath();
      ctx.moveTo(spineStartX, centerY);
      ctx.lineTo(spineEndX, centerY);
      ctx.stroke();

      // Cabe√ßa (problema) ‚Äì lado direito
      ctx.fillStyle = "#e5e7eb";
      ctx.font = "bold 28px system-ui";
      const problemMaxWidth = 320;
      let headY = centerY - 40;
      headY = drawWrappedText(ctx, "Problema:", spineEndX + 10, headY, problemMaxWidth, 32) + 6;

      ctx.font = "24px system-ui";
      headY = drawWrappedText(ctx, problem, spineEndX + 10, headY, problemMaxWidth, 30);

      // Distribuir ramos (alternando cima/baixo)
      const topBranches = [];
      const bottomBranches = [];
      branchData.forEach((b, idx) => {
        if (idx % 2 === 0) topBranches.push(b);
        else bottomBranches.push(b);
      });

      const totalBranches = branchData.length;
      const usableLength = spineEndX - spineStartX - 100;
      const stepX = totalBranches > 1 ? usableLength / (totalBranches - 1) : usableLength / 2;

      // Desenhar ramos
      ctx.lineWidth = 3;
      ctx.font = "20px system-ui";

      let topIndex = 0;
      let bottomIndex = 0;

      branchData.forEach((branch, idx) => {
        const xOnSpine = spineStartX + stepX * idx;

        const isTop = (idx % 2 === 0);
        const offsetIndex = isTop ? topIndex++ : bottomIndex++;

        const length = 180;
        const verticalOffsetBase = 140;
        const verticalStep = 80;
        const yEnd = isTop
          ? centerY - (verticalOffsetBase + offsetIndex * verticalStep)
          : centerY + (verticalOffsetBase + offsetIndex * verticalStep);

        const xEnd = xOnSpine + 100 * (isTop ? 1 : 1);

        // Linha do ramo
        ctx.strokeStyle = "#e5e7eb";
        ctx.beginPath();
        ctx.moveTo(xOnSpine, centerY);
        ctx.lineTo(xEnd, yEnd);
        ctx.stroke();

        // Texto da √°rea + hip√≥teses
        const textX = xEnd + 10;
        let textY = yEnd - 6;

        ctx.fillStyle = "#fbbf24"; // t√≠tulo da √°rea
        ctx.font = "bold 22px system-ui";
        textY = drawWrappedText(ctx, branch.title, textX, textY, 350, 26) + 4;

        ctx.fillStyle = "#e5e7eb";
        ctx.font = "18px system-ui";
        branch.lines.forEach(line => {
          textY = drawWrappedText(ctx, line, textX, textY + 2, 360, 22);
        });
      });

      // Pequeno rodap√©
      ctx.font = "16px system-ui";
      ctx.fillStyle = "#9ca3af";
      ctx.fillText("PlotFish ‚Äì brainstorming de problemas de hist√≥ria", 20, canvas.height - 30);

      // Converter para imagem
      const dataUrl = canvas.toDataURL("image/png");
      const imgEl = document.getElementById("fishboneImage");
      const section = document.getElementById("fishboneSection");
      imgEl.src = dataUrl;
      section.style.display = "block";

      // Scroll at√© √† imagem
      if (section.scrollIntoView) {
        section.scrollIntoView({ behavior: "smooth", block: "start" });
      }
    }

    // Limpar tudo
    function clearAll() {
      if (!confirm("Queres mesmo limpar tudo? Isto apaga o problema, as hip√≥teses e o resumo.")) return;
      document.getElementById("problemDescription").value = "";
      document.getElementById("problemType").value = "";
      document.getElementById("summaryBox").value = "";
      document.getElementById("fishboneSection").style.display = "none";
      document.getElementById("fishboneImage").src = "";
      initAreas();
    }

    // Inicializa√ß√£o
    initAreas();
  </script>
</body>
</html>
