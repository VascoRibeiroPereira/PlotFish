<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <title>PlotFish ‚Äì Entre Sonhos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#121826" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 16px;
      max-width: 900px;
      margin-inline: auto;
      background: #0b1220;
      color: #e5e7eb;
    }
    h1, h2 { margin: 0 0 8px; }
    h1 { font-size: 1.6rem; }
    h2 { font-size: 1.2rem; margin-top: 16px; }
    p {
      margin: 4px 0 8px;
      font-size: 0.95rem;
      color: #cbd5f5;
    }
    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(59,130,246,0.2);
      color: #bfdbfe;
      font-size: 0.8rem;
      margin-bottom: 4px;
    }
    .brand-note {
      font-size: 0.8rem;
      color: #9ca3af;
      margin-top: 2px;
    }
    .brand-note strong {
      color: #e5e7eb;
      font-weight: 600;
    }
    .brand-note a {
      color: #93c5fd;
      text-decoration: underline;
    }
    .card {
      background: radial-gradient(circle at top left, #1f2937, #020617);
      border-radius: 10px;
      padding: 12px 14px;
      margin-bottom: 12px;
      border: 1px solid rgba(148,163,184,0.2);
    }
    label {
      display: block;
      font-size: 0.85rem;
      margin-top: 6px;
      color: #e5e7eb;
    }
    textarea, select {
      width: 100%;
      box-sizing: border-box;
      margin-top: 2px;
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #4b5563;
      background: #020617;
      color: #e5e7eb;
      font-size: 0.9rem;
    }
    textarea { min-height: 60px; resize: vertical; }
    button {
      border: none;
      border-radius: 999px;
      padding: 7px 12px;
      font-size: 0.9rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      margin-top: 8px;
    }
    .primary {
      background: linear-gradient(to right, #3b82f6, #6366f1);
      color: white;
    }
    .secondary {
      background: #111827;
      color: #e5e7eb;
      border: 1px solid #4b5563;
    }
    .danger { background: #b91c1c; color: white; }
    .area-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 4px;
    }
    .area-title-main { font-weight: 600; font-size: 0.95rem; }
    .area-subtitle { font-size: 0.8rem; color: #9ca3af; }
    .hypothesis-card {
      border-radius: 8px;
      border: 1px solid rgba(148,163,184,0.3);
      padding: 8px;
      margin-top: 8px;
      background: rgba(15,23,42,0.8);
    }
    .hypothesis-row {
      display: grid;
      grid-template-columns: 1fr;
      gap: 6px;
    }
    @media (min-width: 640px) {
      .hypothesis-row {
        grid-template-columns: 1.2fr 0.9fr 0.9fr 0.9fr;
      }
    }
    .hypothesis-label {
      font-size: 0.75rem;
      color: #9ca3af;
      margin-top: 4px;
      margin-bottom: 2px;
    }
    #summaryBox {
      min-height: 160px;
      white-space: pre-wrap;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.85rem;
    }
    .small-hint {
      font-size: 0.78rem;
      color: #9ca3af;
    }
    header {
      margin-bottom: 14px;
      padding-bottom: 8px;
      border-bottom: 1px solid rgba(148,163,184,0.3);
    }
    .logo-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }
    .logo-mark {
      font-size: 1.1rem;
      font-weight: 600;
      letter-spacing: 0.04em;
    }
  </style>
</head>
<body>
  <header>
    <div class="logo-row">
      <div>
        <div class="badge">Ferramenta para autores</div>
        <h1>PlotFish</h1>
        <p style="margin-bottom:4px;">
          Ferramenta de brainstorming para autores de fantasia & sci-fi que querem
          <strong>desbloquear problemas da hist√≥ria</strong> em vez de s√≥ sentir ‚Äúisto n√£o est√° a funcionar‚Äù.
        </p>
        <p class="brand-note">
          Um projeto <strong>Entre Sonhos</strong> ¬∑ ig: <strong>@blog_entre_sonhos</strong><br>
          <a href="https://vascoribeiropereira.github.io/entresonhos-site/recursos/plotfish/" target="_blank" rel="noopener noreferrer">
            Guia completo do PlotFish
          </a>
        </p>
      </div>
      <div class="logo-mark">üêü</div>
    </div>
    <p class="small-hint">
      Come√ßa por descrever o problema, depois explora hip√≥teses por √°rea (personagens, enredo, mundo, etc.).
      No final, gera um resumo, um diagrama fishbone e define 1‚Äì3 mudan√ßas concretas para testar na hist√≥ria.
    </p>
  </header>

  <!-- PASSO 1 -->
  <section class="card">
    <h2>Passo 1 ¬∑ Qual √© o problema da hist√≥ria?</h2>
    <label>
      Descreve, em linguagem simples, o que n√£o est√° a funcionar.
      <textarea id="problemDescription" placeholder="Ex.: O cl√≠max da hist√≥ria √© morno; quando a personagem X morre, n√£o sinto impacto; o meio do livro arrasta."></textarea>
    </label>

    <label>
      Tipo de problema (opcional)
      <select id="problemType">
        <option value="">N√£o tenho a certeza / prefiro n√£o escolher</option>
        <option value="Cena espec√≠fica">Cena espec√≠fica</option>
        <option value="Arco de personagem">Arco de personagem</option>
        <option value="Cl√≠max / final">Cl√≠max / final</option>
        <option value="Ritmo / enchimento">Ritmo / enchimento</option>
        <option value="Mundo / magia / tecnologia">Mundo / magia / tecnologia</option>
      </select>
    </label>
  </section>

  <!-- PASSO 2 -->
  <section>
    <h2>Passo 2 ¬∑ Explora onde o problema pode estar</h2>
    <p class="small-hint">
      Usa as √°reas abaixo como ‚Äúespinhas‚Äù do teu fishbone. Para cada uma que fizer sentido,
      escreve hip√≥teses e, se quiseres, aprofunda com at√© 3 ‚Äúporqu√™s‚Äù.
    </p>

    <div id="areasContainer"></div>
  </section>

  <!-- PASSO 3 -->
  <section class="card" style="margin-top:16px;">
    <h2>Passo 3 ¬∑ Resumo, imagem e ficheiro</h2>
    <p class="small-hint">
      Gera um texto com o problema, as √°reas onde suspeitas que est√° a falha e as hip√≥teses que
      queres explorar. Podes tamb√©m gerar uma imagem fishbone e exportar/importar o projeto como ficheiro.
    </p>
    <div style="display:flex;flex-wrap:wrap;gap:8px;">
      <button class="primary" type="button" onclick="generateSummary()">
        üßæ Gerar resumo
      </button>
      <button class="secondary" type="button" onclick="copySummary()">
        üìã Copiar resumo
      </button>
      <button class="secondary" type="button" onclick="generateFishboneImage()">
        üé® Gerar imagem fishbone
      </button>
      <button class="secondary" type="button" onclick="downloadSessionFile()">
        ‚¨áÔ∏è Exportar ficheiro
      </button>
      <button class="secondary" type="button" onclick="triggerImportFile()">
        ‚¨ÜÔ∏è Importar ficheiro
      </button>
      <button class="secondary" type="button" onclick="clearAll()">
        üßπ Limpar tudo
      </button>
    </div>

    <!-- input escondido para importar ficheiros -->
    <input
      type="file"
      id="importFileInput"
      accept=".json,application/json"
      style="display:none"
      onchange="handleImportFile(event)"
    />

    <label style="margin-top:10px;">
      Resultado (resumo do brainstorm)
      <textarea id="summaryBox" readonly></textarea>
    </label>
  </section>

  <!-- PASSO 4 -->
  <section class="card" style="margin-top:16px;">
    <h2>Passo 4 ¬∑ O que vou mudar?</h2>
    <p class="small-hint">
      Depois de olhares para o resumo ou para o fishbone, escolhe 1‚Äì3 mudan√ßas concretas que queres testar.
      Mant√©m isto simples e acion√°vel: cenas a reescrever, motiva√ß√µes a clarificar, stakes a aumentar, etc.
    </p>

    <label>
      Mudan√ßa 1 a testar
      <textarea id="change1" placeholder="Ex.: Reescrever a cena da morte da personagem X, mostrando as rea√ß√µes das outras personagens."></textarea>
    </label>
    <label>
      Mudan√ßa 2 a testar (opcional)
      <textarea id="change2" placeholder="Ex.: Clarificar o que o protagonista arrisca perder antes do cl√≠max."></textarea>
    </label>
    <label>
      Mudan√ßa 3 a testar (opcional)
      <textarea id="change3" placeholder="Ex.: Cortar ou condensar a sequ√™ncia no meio do livro que n√£o avan√ßa o conflito."></textarea>
    </label>

    <button class="secondary" type="button" onclick="copyChangesPlan()">
      üìã Copiar plano de mudan√ßas
    </button>
    <p class="small-hint">
      Dica: podes colar este plano diretamente no teu editor de texto ou numa nota ao lado da cena que vais trabalhar.
    </p>
  </section>

  <!-- IMAGEM FISHBONE -->
  <section id="fishboneSection" style="margin-top:16px; display:none;">
    <h2>Diagrama fishbone</h2>
    <p class="small-hint">
      Diagrama gerado a partir do problema e das hip√≥teses que escreveste. Mant√©m o dedo em cima
      da imagem (no telem√≥vel/tablet) para guardar ou partilhar.
    </p>
    <div class="card">
      <img id="fishboneImage" alt="Diagrama fishbone gerado" style="width:100%;max-width:100%;border-radius:8px;display:block;" />
    </div>
  </section>

  <script>
    "use strict";

    // √Åreas fixas (6 ramos)
    const AREAS = [
      {
        id: "personagens",
        title: "Personagens",
        subtitle: "Motiva√ß√µes, decis√µes, rea√ß√µes, arcos.",
        hints: [
          "As motiva√ß√µes est√£o claras?",
          "As decis√µes fazem sentido com quem a personagem √©?",
          "H√° algo que devia doer mais (ou menos)?"
        ]
      },
      {
        id: "enredo",
        title: "Enredo (plot)",
        subtitle: "Acontecimentos, viragens, consequ√™ncia dos atos.",
        hints: [
          "As causas e efeitos est√£o claros?",
          "H√° atalhos convenientes a mais?",
          "O cl√≠max foi preparado ao longo da hist√≥ria?"
        ]
      },
      {
        id: "conflito",
        title: "Conflito & stakes",
        subtitle: "O que est√° em jogo, o que se perde se falhar.",
        hints: [
          "O leitor sente o que est√° em risco?",
          "O protagonista tem mesmo algo a perder?",
          "Se falhar, acontece algo significativo?"
        ]
      },
      {
        id: "mundo",
        title: "Mundo / magia / tecnologia",
        subtitle: "Regras, custo, limites, coer√™ncia interna.",
        hints: [
          "As regras s√£o claras o suficiente?",
          "H√° magia/tech a resolver tudo sem custo?",
          "O mundo reage √†s a√ß√µes das personagens?"
        ]
      },
      {
        id: "tema",
        title: "Tema & emo√ß√£o",
        subtitle: "Mensagem, tom, impacto emocional.",
        hints: [
          "Que emo√ß√£o querias que o leitor sentisse aqui?",
          "A cena est√° alinhada com o tema da hist√≥ria?",
          "H√° conflito interno suficiente?"
        ]
      },
      {
        id: "ritmo",
        title: "Ritmo & estrutura",
        subtitle: "Partes que arrastam, saltos bruscos, enchimento.",
        hints: [
          "H√° cenas que repetem a mesma fun√ß√£o?",
          "Chegaste cedo demais ou tarde demais ao ponto chave?",
          "H√° blocos de info que podiam ser divididos?"
        ]
      }
    ];

    // --- Constru√ß√£o das √°reas ---
    function initAreas() {
      const container = document.getElementById("areasContainer");
      container.innerHTML = "";

      AREAS.forEach(area => {
        const card = document.createElement("div");
        card.className = "card";
        card.dataset.areaId = area.id;

        card.innerHTML = `
          <div class="area-header">
            <div>
              <div class="area-title-main">${area.title}</div>
              <div class="area-subtitle">${area.subtitle}</div>
            </div>
            <button type="button" class="secondary" onclick="addHypothesis('${area.id}')">
              + Adicionar hip√≥tese
            </button>
          </div>
          <p class="small-hint">
            Sugest√µes para pensar: ${area.hints.join(" ¬∑ ")}
          </p>
          <div class="small-hint">
            Usa esta √°rea se achas que o problema pode estar aqui. Podes adicionar v√°rias hip√≥teses
            e aprofundar com at√© 3 ‚Äúporqu√™s‚Äù cada.
          </div>
          <div class="hypotheses-container" id="hypotheses-${area.id}"></div>
        `;

        container.appendChild(card);
      });
    }

    function addHypothesis(areaId) {
      const container = document.getElementById(`hypotheses-${areaId}`);
      if (!container) return;

      const hypIndex = container.children.length + 1;

      const wrapper = document.createElement("div");
      wrapper.className = "hypothesis-card";

      wrapper.innerHTML = `
        <div class="hypothesis-row">
          <div>
            <div class="hypothesis-label">Hip√≥tese #${hypIndex}</div>
            <textarea
              placeholder="Ex.: O protagonista aceita o risco demasiado depressa."
              class="hypothesis-text"
            ></textarea>
          </div>
          <div>
            <div class="hypothesis-label">Porqu√™ 1 (o que pode estar por tr√°s?)</div>
            <textarea class="why1" placeholder="Ex.: Porque n√£o mostrei o que ele tem a perder."></textarea>
          </div>
          <div>
            <div class="hypothesis-label">Porqu√™ 2 (e isso porqu√™?)</div>
            <textarea class="why2" placeholder="Ex.: Porque nunca foquei a vida 'normal' dele."></textarea>
          </div>
          <div>
            <div class="hypothesis-label">Porqu√™ 3 (h√° algo ainda mais fundo?)</div>
            <textarea class="why3" placeholder="Ex.: Porque n√£o defini claramente o medo central dele."></textarea>
          </div>
        </div>
        <button type="button" class="danger" style="margin-top:6px;" onclick="removeHypothesis(this)">
          Remover hip√≥tese
        </button>
      `;

      container.appendChild(wrapper);
    }

    function removeHypothesis(buttonEl) {
      const card = buttonEl.closest(".hypothesis-card");
      if (card && card.parentElement) {
        card.parentElement.removeChild(card);
      }
    }

    // --- Resumo ---
    function generateSummary() {
      const problem = document.getElementById("problemDescription").value.trim();
      const type = document.getElementById("problemType").value;

      if (!problem) {
        alert("Come√ßa por descrever o problema da hist√≥ria no Passo 1.");
        return;
      }

      let lines = [];

      lines.push("PLOT FISH ‚Äì RESUMO DO BRAINSTORM");
      lines.push("=".repeat(40));
      lines.push("");

      lines.push("Problema descrito:");
      lines.push(problem);
      lines.push("");

      if (type) {
        lines.push(`Tipo de problema: ${type}`);
        lines.push("");
      }

      lines.push("√Åreas exploradas e hip√≥teses:");
      lines.push("");

      AREAS.forEach(area => {
        const container = document.getElementById(`hypotheses-${area.id}`);
        if (!container) return;
        const cards = Array.from(container.getElementsByClassName("hypothesis-card"));
        if (cards.length === 0) return;

        lines.push(`- ${area.title}:`);
        cards.forEach((card, idx) => {
          const hyp = card.querySelector(".hypothesis-text")?.value.trim();
          const why1 = card.querySelector(".why1")?.value.trim();
          const why2 = card.querySelector(".why2")?.value.trim();
          const why3 = card.querySelector(".why3")?.value.trim();

          if (!hyp && !why1 && !why2 && !why3) return;

          lines.push(`  ‚Ä¢ Hip√≥tese ${idx + 1}: ${hyp || "(n√£o preenchido)"}`);
          if (why1) lines.push(`      ‚Äì Porqu√™ 1: ${why1}`);
          if (why2) lines.push(`      ‚Äì Porqu√™ 2: ${why2}`);
          if (why3) lines.push(`      ‚Äì Porqu√™ 3: ${why3}`);
        });
        lines.push("");
      });

      lines.push("Notas para revis√£o:");
      lines.push("‚Ä¢ Olhar para as hip√≥teses com mais 'porqu√™s' preenchidos ‚Äì podem indicar causas mais profundas.");
      lines.push("‚Ä¢ Escolher 1‚Äì3 mudan√ßas concretas para testar (reescrever uma cena, clarificar motiva√ß√µes, alterar stakes, etc.).");

      document.getElementById("summaryBox").value = lines.join("\n");
    }

    function copySummary() {
      const summaryEl = document.getElementById("summaryBox");
      const text = summaryEl.value;
      if (!text.trim()) {
        alert("Ainda n√£o h√° resumo para copiar. Gera primeiro o resumo.");
        return;
      }

      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text)
          .then(() => alert("Resumo copiado. Cola no teu editor de texto ou notas."))
          .catch(err => {
            console.error("Erro a copiar para clipboard", err);
            fallbackCopy(text);
          });
      } else {
        fallbackCopy(text);
      }
    }

    function fallbackCopy(text) {
      window.prompt("Copia manualmente o texto (Ctrl+C / Command+C) e depois Enter:", text);
    }

    // helper para texto no canvas
    function drawWrappedText(ctx, text, x, y, maxWidth, lineHeight) {
      const words = text.split(" ");
      let line = "";
      for (let n = 0; n < words.length; n++) {
        const testLine = line + words[n] + " ";
        const metrics = ctx.measureText(testLine);
        const testWidth = metrics.width;
        if (testWidth > maxWidth && n > 0) {
          ctx.fillText(line, x, y);
          line = words[n] + " ";
          y += lineHeight;
        } else {
          line = testLine;
        }
      }
      if (line) ctx.fillText(line, x, y);
      return y;
    }

    // --- Imagem fishbone com margens sim√©tricas + espelho ---
    function generateFishboneImage() {
      const problem = document.getElementById("problemDescription").value.trim();
      if (!problem) {
        alert("Para gerar o fishbone, primeiro descreve o problema no Passo 1.");
        return;
      }

      function clamp(v, min, max) {
        return Math.max(min, Math.min(max, v));
      }

      // causas finais por √°rea
      const branches = AREAS.map(area => {
        const container = document.getElementById(`hypotheses-${area.id}`);
        const causes = [];
        if (container) {
          const cards = Array.from(container.getElementsByClassName("hypothesis-card"));
          cards.forEach(card => {
            const hyp  = (card.querySelector(".hypothesis-text")?.value || "").trim();
            const why1 = (card.querySelector(".why1")?.value || "").trim();
            const why2 = (card.querySelector(".why2")?.value || "").trim();
            const why3 = (card.querySelector(".why3")?.value || "").trim();

            let cause = why3 || why2 || why1 || hyp;
            if (!cause) return;

            const MAX_CHARS = 80;
            if (cause.length > MAX_CHARS) cause = cause.slice(0, MAX_CHARS) + "‚Ä¶";
            causes.push(cause);
          });
        }
        return { title: area.title, causes };
      });

      const topOrder    = [0, 2, 4];
      const bottomOrder = [1, 3, 5];
      const pairs = [];
      for (let i = 0; i < 3; i++) {
        pairs.push({
          top: branches[topOrder[i]],
          bottom: branches[bottomOrder[i]]
        });
      }

      const canvas = document.createElement("canvas");
      canvas.width = 2400;
      canvas.height = 1350;
      const ctx = canvas.getContext("2d");

      const outerMargin = 120;
      const branchTipOffset = 260;

      // fundo
      const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
      gradient.addColorStop(0, "#020617");
      gradient.addColorStop(1, "#111827");
      ctx.fillStyle = gradient;
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      const centerY = canvas.height / 2;

      // cabe√ßa + espinha calculadas por margens
      const problemMaxWidth = 520;
      const headX = canvas.width - outerMargin - problemMaxWidth;
      const spineEndX = headX - 80;
      const spineStartX = outerMargin + branchTipOffset;

      ctx.strokeStyle = "#e5e7eb";
      ctx.lineWidth = 4;
      ctx.beginPath();
      ctx.moveTo(spineStartX, centerY);
      ctx.lineTo(spineEndX, centerY);
      ctx.stroke();

      let headY = centerY - 120;
      ctx.fillStyle = "#e5e7eb";
      ctx.font = "bold 36px system-ui";
      headY = drawWrappedText(ctx, "Problema:", headX, headY, problemMaxWidth, 42) + 32;

      ctx.font = "28px system-ui";
      drawWrappedText(ctx, problem, headX, headY, problemMaxWidth, 38);

      // ramos (3 colunas em espelho)
      const pairCount = pairs.length;
      const usableLength = spineEndX - spineStartX - 40;
      const stepX = usableLength / (pairCount - 1 || 1);

      const verticalOffsets = [220, 360, 500];
      const maxTextWidth = 360;
      const margin = outerMargin;

      ctx.lineWidth = 3;

      for (let j = 0; j < pairCount; j++) {
        const xSpine = spineStartX + stepX * j;
        const offset = verticalOffsets[j] || verticalOffsets[verticalOffsets.length - 1];

        // ramo de cima
        const topBranch = pairs[j].top;
        if (topBranch) {
          const yTipTop = centerY - offset;
          const xTipTop = xSpine - branchTipOffset;

          ctx.strokeStyle = "#e5e7eb";
          ctx.beginPath();
          ctx.moveTo(xSpine, centerY);
          ctx.lineTo(xTipTop, yTipTop);
          ctx.stroke();

          ctx.fillStyle = "#fbbf24";
          ctx.font = "bold 22px system-ui";
          let titleYTop = yTipTop - 18;
          let titleXTop = xTipTop - maxTextWidth / 2;
          titleXTop = clamp(titleXTop, margin, canvas.width - maxTextWidth - margin);
          titleYTop = drawWrappedText(ctx, topBranch.title, titleXTop, titleYTop, maxTextWidth, 26) + 8;

          ctx.fillStyle = "#e5e7eb";
          ctx.font = "18px system-ui";
          const causesTop = topBranch.causes;
          const nTop = causesTop.length;
          for (let i = 0; i < nTop; i++) {
            const t = (i + 1) / (nTop + 1);
            const xAlong = xSpine + (xTipTop - xSpine) * t;
            const yAlong = centerY + (yTipTop - centerY) * t;

            let textX = xAlong - maxTextWidth / 2;
            textX = clamp(textX, margin, canvas.width - maxTextWidth - margin);
            const textY = yAlong - 10;
            drawWrappedText(ctx, "‚Äì " + causesTop[i], textX, textY, maxTextWidth, 22);
          }
        }

        // ramo de baixo
        const bottomBranch = pairs[j].bottom;
        if (bottomBranch) {
          const yTipBot = centerY + offset;
          const xTipBot = xSpine - branchTipOffset;

          ctx.strokeStyle = "#e5e7eb";
          ctx.beginPath();
          ctx.moveTo(xSpine, centerY);
          ctx.lineTo(xTipBot, yTipBot);
          ctx.stroke();

          ctx.fillStyle = "#fbbf24";
          ctx.font = "bold 22px system-ui";
          let titleYBot = yTipBot + 30;
          let titleXBot = xTipBot - maxTextWidth / 2;
          titleXBot = clamp(titleXBot, margin, canvas.width - maxTextWidth - margin);
          titleYBot = drawWrappedText(ctx, bottomBranch.title, titleXBot, titleYBot, maxTextWidth, 26) + 8;

          ctx.fillStyle = "#e5e7eb";
          ctx.font = "18px system-ui";
          const causesBot = bottomBranch.causes;
          const nBot = causesBot.length;
          for (let i = 0; i < nBot; i++) {
            const t = (i + 1) / (nBot + 1);
            const xAlong = xSpine + (xTipBot - xSpine) * t;
            const yAlong = centerY + (yTipBot - centerY) * t;

            let textX = xAlong - maxTextWidth / 2;
            textX = clamp(textX, margin, canvas.width - maxTextWidth - margin);
            const textY = yAlong + 24;
            drawWrappedText(ctx, "‚Äì " + causesBot[i], textX, textY, maxTextWidth, 22);
          }
        }
      }

      ctx.font = "14px system-ui";
      ctx.fillStyle = "#9ca3af";
      ctx.fillText("PlotFish ¬∑ Entre Sonhos ¬∑ ig: @blog_entre_sonhos", 20, canvas.height - 30);

      const dataUrl = canvas.toDataURL("image/png");
      const imgEl = document.getElementById("fishboneImage");
      const section = document.getElementById("fishboneSection");
      imgEl.src = dataUrl;
      section.style.display = "block";
      if (section.scrollIntoView) {
        section.scrollIntoView({ behavior: "smooth", block: "start" });
      }
    }

    // --- Exportar / importar estado (ficheiro) ---
    function exportState() {
      const state = {
        problem: document.getElementById("problemDescription").value || "",
        type: document.getElementById("problemType").value || "",
        areas: {},
        changes: {
          change1: document.getElementById("change1").value || "",
          change2: document.getElementById("change2").value || "",
          change3: document.getElementById("change3").value || ""
        }
      };
      AREAS.forEach(area => {
        const container = document.getElementById(`hypotheses-${area.id}`);
        if (!container) return;
        const cards = Array.from(container.getElementsByClassName("hypothesis-card"));
        if (cards.length === 0) return;
        state.areas[area.id] = cards.map(card => ({
          hyp: card.querySelector(".hypothesis-text")?.value || "",
          why1: card.querySelector(".why1")?.value || "",
          why2: card.querySelector(".why2")?.value || "",
          why3: card.querySelector(".why3")?.value || ""
        }));
      });
      return state;
    }

    function importState(state) {
      document.getElementById("problemDescription").value = state.problem || "";
      document.getElementById("problemType").value = state.type || "";
      initAreas();
      if (state.areas) {
        Object.keys(state.areas).forEach(areaId => {
          const list = state.areas[areaId] || [];
          list.forEach(item => {
            addHypothesis(areaId);
            const container = document.getElementById(`hypotheses-${areaId}`);
            const cards = container.getElementsByClassName("hypothesis-card");
            const card = cards[cards.length - 1];
            if (!card) return;
            card.querySelector(".hypothesis-text").value = item.hyp || "";
            card.querySelector(".why1").value = item.why1 || "";
            card.querySelector(".why2").value = item.why2 || "";
            card.querySelector(".why3").value = item.why3 || "";
          });
        });
      }
      if (state.changes) {
        document.getElementById("change1").value = state.changes.change1 || "";
        document.getElementById("change2").value = state.changes.change2 || "";
        document.getElementById("change3").value = state.changes.change3 || "";
      }
    }

    function downloadSessionFile() {
      const state = exportState();
      const blob = new Blob([JSON.stringify(state, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      const now = new Date();
      const iso = now.toISOString().replace(/[:.]/g, "-");
      a.href = url;
      a.download = `plotfish-${iso}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function triggerImportFile() {
      const input = document.getElementById("importFileInput");
      if (input) input.click();
    }

    function handleImportFile(event) {
      const file = event.target.files && event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const text = e.target.result;
          const state = JSON.parse(text);
          importState(state);
          alert("Projeto carregado a partir do ficheiro.");
        } catch (err) {
          console.error("Erro ao importar ficheiro", err);
          alert("N√£o consegui ler o ficheiro. Confirma se √© um ficheiro gerado pelo PlotFish.");
        } finally {
          event.target.value = "";
        }
      };
      reader.readAsText(file);
    }

    // --- Plano de mudan√ßas (Passo 4) ---
    function copyChangesPlan() {
      const c1 = document.getElementById("change1").value.trim();
      const c2 = document.getElementById("change2").value.trim();
      const c3 = document.getElementById("change3").value.trim();

      if (!c1 && !c2 && !c3) {
        alert("Escreve pelo menos uma mudan√ßa que queres testar.");
        return;
      }

      let lines = [];
      lines.push("PLOT FISH ‚Äì PLANO DE MUDAN√áAS");
      lines.push("=".repeat(36));
      lines.push("");

      if (c1) lines.push("Mudan√ßa 1 a testar: " + c1);
      if (c2) lines.push("Mudan√ßa 2 a testar: " + c2);
      if (c3) lines.push("Mudan√ßa 3 a testar: " + c3);

      const text = lines.join("\n");

      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text)
          .then(() => alert("Plano de mudan√ßas copiado. Cola junto da cena que vais editar."))
          .catch(err => {
            console.error("Erro a copiar plano", err);
            fallbackCopy(text);
          });
      } else {
        fallbackCopy(text);
      }
    }

    // --- limpar tudo ---
    function clearAll() {
      if (!confirm("Queres mesmo limpar tudo? Isto apaga o problema, as hip√≥teses, o resumo e o plano de mudan√ßas.")) return;
      document.getElementById("problemDescription").value = "";
      document.getElementById("problemType").value = "";
      document.getElementById("summaryBox").value = "";
      document.getElementById("fishboneSection").style.display = "none";
      document.getElementById("fishboneImage").src = "";
      document.getElementById("change1").value = "";
      document.getElementById("change2").value = "";
      document.getElementById("change3").value = "";
      initAreas();
    }

    // --- init ---
    (function initApp() {
      initAreas();
    })();
  </script>
</body>
</html>
